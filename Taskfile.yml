version: '3'

vars:
  IMAGE_TAG:
    sh: sh next_version
  VERSION_TO_DEPLOY:
    sh: git tag --sort=-creatordate | head -n 1

tasks:
  start-local:
    cmds:
      - cmd: docker compose up --build --detach
  stop-local:
    cmds:
      - cmd: docker compose down
  gen:
    cmds:
      - cmd: sqlc generate
  test:
    cmds:
      - cmd: set -euo pipefail && go test -json -v ./... 2>&1 | gotestfmt
  lint:
    cmds:
      - cmd: golangci-lint run
      - cmd: npm run lint --prefix frontend
  fmt:
    cmds:
      - cmd: golangci-lint fmt
  release:
    requires:
      vars: [ IMAGE_TAG ]
    cmds:
      - cmd: docker buildx build --target runner -t ghcr.io/torfstack/synod:{{.IMAGE_TAG}} .
      - cmd: docker push ghcr.io/torfstack/synod:{{.IMAGE_TAG}}
  deploy:
    requires:
      vars: [ VERSION_TO_DEPLOY ]
    cmds:
      - cmd: helm upgrade --install synod deployment --set tag={{.VERSION_TO_DEPLOY}}
  dev-deploy:
    vars:
      DEV_IMAGE_TAG: development
    cmds:
      - task: release
        vars:
          IMAGE_TAG:
            ref: .DEV_IMAGE_TAG
      - task: deploy
        vars:
          VERSION_TO_DEPLOY:
            ref: .DEV_IMAGE_TAG
